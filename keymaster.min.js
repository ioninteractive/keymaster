//     keymaster.js
//     (c) 2011 Thomas Fuchs
//     keymaster.js may be freely distributed under the MIT license.
define(["jquery","underscore"],function(n,t){function s(n){var t=n.keyCode;(t==93||t==224)&&(t=91),t in i&&(i[t]=!1)}function c(){for(var n in i)i[n]=!1}for(var o={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},h={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},r={},i={16:!1,18:!1,17:!1,91:!1},f="all",e,u=1;u<20;u++)o["f"+u]=111+u;e={assignKey:function(n,i,u,f){n=n.replace(/\s/g,""),n=t(n.split(",")),n.last()===""&&(n[n.length-2]+=",");var c,s,e;n.each(function(n){var l,a;if(s=[],c=t(n.split("+")),c.size()>1)for(s=c.initial(),l=0;l<s.length;l++)s[l]=o[s[l]];e=c.last(),e=h[e]||e.toUpperCase().charCodeAt(0),e in r||(r[e]=[]),a=t(r[e]).any(function(t){return t.shortcut===n&&t.scope===i&&t.method===u&&t.context===f}),a||r[e].push({shortcut:n,modifiers:s,scope:i,method:u,context:f,boundMethod:f?t.bind(u,f):u})})},filter:function(n){var t=(n.target||n.srcElement).tagName;return!(t=="INPUT"||t=="SELECT"||t=="TEXTAREA")},getScope:function(){return f||"all"},setScope:function(n){f=n||"all"},deleteScope:function(n){var i,u,f=function(t){return t.scope!==n};for(i in r)u=r[i],r[i]=t(u).filter(f)},dispatch:function(n,u){var f=n.keyCode,e;if((f==93||f==224)&&(f=91),f in i){i[f]=!0;return}this.filter.call(this,n)&&f in r&&(e=t(t.filter(r[f],function(n){return n.scope===u||n.scope==="all"})),e.each(function(r){var f=r.modifiers.length>0,u;for(u in i)(!i[u]&&t.indexOf(r.modifiers,+u)>-1||i[u]&&t.indexOf(r.modifiers,+u)==-1)&&(f=!1);!f&&(r.modifiers.length!==0||i[16]||i[18]||i[17]||i[91])||r.boundMethod(n,r)===!1&&(n.preventDefault(),n.stopPropagation())}))},attachTo:function(t){n(t).on("keydown",function(n){e.dispatch(n,f)}).on("keyup",s)},detachFrom:function(t){n(t).off("keydown").off("keyup")}};n(document).on("keydown",function(n){e.dispatch(n,f)}).on("keyup",s);n(window).on("keyup",c);return e});